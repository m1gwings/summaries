---
marp: true
theme: summary
math: mathjax
---
# Storage

<div class="author">

Cristiano Migali
(_adapted from the slides of Prof. Manuel Roveri_)

</div>

<style>
section {
    font-size: x-large;
}

.definition {
    padding-left: 0.5cm;
    padding-right: 0.5cm;
    background: var(--algorithms);
    border-radius: 0.5cm;
    border-style: solid;
    border-color: var(--text);
    border-width: 3pt;
    text-align: justify;
}
</style>

## Trends

The growth of the "_Global Datasphere_" (the volume of all the data created in the world) in the last 15 years has been _exponential_. Between 80s and 90s most of the data was generated by humans. Nowadays machines generate data at an unprecedented rate.
Along with this growth, we can observe a shift to centralized storage (storing data in the cloud) because of the ease of maintenance for the consumer.
Storage technology is (_still_) **dominated by HDDs**, even though the **fraction** of data **stored** in **SSD** devices is **growing**. A (_almost_) constant fraction of data is (**_still_**) stored in **tapes**.

There are also some hybrid HDD+SSD solutions:
- some large storage servers use _SSD_ as a cache for several _HDDs_;
- some HDD manufacturers produce **Solid State Hybrid Disks** (**SSHDs**) that combine a _small SSD_ with a _large HDD_ is a single unit.

---

## Disk abstraction

_Disks_ are seen by the OS as a **collection of data blocks** that can be _read or written independently_. To allow the ordering/management between them, each block is characterized by a unique numerical address called **Logical Block Address** (**LBA**).
Typically the OS _groups blocks_ into **clusters** to simplify the access to the disk. They are the _minimal unit_ the OS can read from ro write to a disk. Clusters' size ranges from 1 _sector_ (_see later_) (512 B) to 128 sectors (64 KiB).

### What's inside clusters?

We can distinguish between _4 types of clusters_ according to their _content_ (_and position_).
- Fixed position, meta-data clusters: are needed to bootstrap the file system (_locate the variable position meta data clusters_).
- Variable position, meta-data clusters: hold the folder structure.
- File data clusters: store the actual files' content.
- Unused space: they are clusters which can be used to store new files and folders.

In particular **meta-data clusters contain**:
- file names;
- directory structures and symbolic links;

---

- file size and file type;
- creation, modification, and last access dates of files;
- security information (owner, access lists, ...);
- **the LBA where the file content can be located on the disk**.

### Operating on disks
#### Reading

**Reading a file** requires to:
1. Access the meta-data to locate its blocks.
2. Access the blocks to read its content.

#### Writing

**Writing a file** requires to:
1. Access the meta-data to locate free space.
2. Write the data in the assigned block.

#### Deleting

**Deleting a file** requires to:
1. (_Just_) Update the meta-data to mark the blocks where the file was stored as free. 

---

**Remark**: deleting a file never actually deletes the data on the disk. When a new file will be written on the same clusters, the old data will be replaced by the new one.

### Disks fragmentation

#### Internal fragmentation

Since the file system can only access clusters, the _real occupation_ of space _by a file_ on the disk is always a _multiple of the cluster size_.
In particular: let $s$ be the file size, $c$ be the cluster size, $a$ be the actual size of the file on disk. Then:
$$
a = c \left\lceil \frac{s}{c} \right\rceil .
$$
The quantity $w = a - s$ is **wasted disk space** due to the organization of the file into clusters. This waste of space is called **internal fragmentation** of files.

#### External fragmentation

As the life of the disk evolves there might be not enough space to store a file in contiguous clusters. In this case the file is split into smaller chunks that are stored in the free clusters spread over the disk.
The effect of splitting a file into non-contiguous clusters is called **external fragmentation**.

---

## Devices
### Hard Disk Drive (HDD)

An **HDD** is a data storage device using rotated disks coated with magnetic material. Data is read and written in a _random-access_ manner, meaning that individual blocks of data can be stored and retrieved in any order.

#### Anatomy of a HDD

The rotating disks on which the HDD stores the data are known as **platters**: they are of equal radius, concentric, and vertically stacked on an axis known as **spindle**. Each platter is split in a fixed number of circular crowns, all with the same difference between external and internal radii, known as **tracks**. The set of tracks on different platters which have the same internal (and hence external) radius (i.e. they are one on top of the other) form a **cylinder**.
Each platter is split in a fixed number of circular sectors, all defined by the same angle; the intersection between a circular sector and a track on the same platter define a **sector**. Sectors are the _minimal units_ that can be written or read from an HDD. They usually allow to store 512 B or 4096 B. A _write to a single sector_ is _atomic_. _Multiple sectors writes_ instead can be interrupted (failing), we call these **torn writes**.

---

For each platter there is a **read-write head** which allows the storage and retrieval of data from sectors; the heads are mounted on an actuated arm which allows to place them on top of the desired track.
Finally, also the spindle is actuated to make the platters spin at a constant rate, measured in Revolutions Per Minute (RPM).

#### Caching for a HDD

Many disks incorporate caches, known as **track buffers**. Usually these are implemented through small amounts of RAM (8, 16, or 32 MiB). Flash memories are used instead to have persistent caching.

When _reading_, caching allows to reduce the delays.

When _writing_ we distinguish two different behaviors.
- **Write back cache**: the drive reports that writes are _complete after they have been cached_. This approach allows to reduce also write delays, but can be dangerous when using non-persistent caching, since, if power goes off, we would loose the cached data which hasn't been written to disk yet.
- **Write through cache**: the drive reports that writes are _complete after they have been written to the disk (and to the cache)_.

---

#### Operations delay for a HDD

The **total delay** of operations performed on a HDD is the sum of _4 components_:
1. **Rotational delay**: it is the time required to rotate the platter as to place the desired sector under the read head, _assuming that the head is on the right track_.
2. **Seek delay**: it is the time required to move the read head to the desired track;
3. **Transfer time**: it is the time required by the actual reading or writing of the desired amount of bytes;
4. **Controller overhead**: it is the overhead due to requests management.

**Remark**: sectors are numbered in such a way that successive sectors which are on the same platter but on different tracks are _skewed_ to take into account the angle by which the platters rotate during the seek delay of moving the head from one track to the adjacent one. This makes sequential reads and writes more efficient.

##### Rotational delay

We call **full rotation delay** $R$ the time required for a full revolution of the platters. Said $\omega$ the platters angular velocity in RPMs,
$$
R = \frac{1 \text{ revolution}}{\omega} \text{ [ minutes ] }.
$$

---

